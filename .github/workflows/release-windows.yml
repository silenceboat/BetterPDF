name: Release Windows

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    env:
      UV_CACHE_DIR: ${{ runner.temp }}\uv-cache

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          architecture: "x64"

      - name: Setup uv
        uses: astral-sh/setup-uv@v4

      - name: Resolve version
        id: meta
        shell: pwsh
        run: |
          if ($env:GITHUB_REF_TYPE -eq "tag") {
            $version = $env:GITHUB_REF_NAME.TrimStart('v')
          }
          else {
            $version = "0.0.0-dev.$env:GITHUB_RUN_NUMBER"
          }
          "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "Resolved version: $version"

      - name: Download WebView2 Bootstrapper
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path build_assets/webview2 -Force | Out-Null
          Invoke-WebRequest -Uri "https://go.microsoft.com/fwlink/p/?LinkId=2124703" -OutFile "build_assets/webview2/MicrosoftEdgeWebView2Setup.exe"

      - name: Build Windows binaries
        shell: pwsh
        run: |
          powershell -ExecutionPolicy Bypass -File scripts/build_windows.ps1 -Version "${{ steps.meta.outputs.version }}"

      - name: Install Inno Setup
        shell: pwsh
        run: |
          choco install innosetup --no-progress -y

      - name: Build installer
        shell: pwsh
        run: |
          $iscc = "${env:ProgramFiles(x86)}\\Inno Setup 6\\ISCC.exe"
          if (!(Test-Path $iscc)) {
            throw "ISCC not found: $iscc"
          }
          & $iscc /DMyAppVersion=${{ steps.meta.outputs.version }} /DDistDir=dist\\BetterPDF /DWebView2Setup=build_assets\\webview2\\MicrosoftEdgeWebView2Setup.exe installer\\BetterPDF.iss

      - name: Build portable archive
        shell: pwsh
        run: |
          $portableName = "BetterPDF-${{ steps.meta.outputs.version }}-win-x64-portable.zip"
          if (Test-Path "dist/temp-portable") {
            Remove-Item "dist/temp-portable" -Recurse -Force
          }
          New-Item -ItemType Directory -Path "dist/temp-portable/BetterPDF" -Force | Out-Null
          Copy-Item -Path "dist/BetterPDF/*" -Destination "dist/temp-portable/BetterPDF" -Recurse -Force
          Compress-Archive -Path "dist/temp-portable/BetterPDF" -DestinationPath "dist/$portableName" -Force

      - name: Generate SHA256 checksums
        shell: pwsh
        run: |
          $setup = "dist/BetterPDF-${{ steps.meta.outputs.version }}-win-x64-setup.exe"
          $portable = "dist/BetterPDF-${{ steps.meta.outputs.version }}-win-x64-portable.zip"
          $checksumFile = "dist/SHA256SUMS.txt"
          if (Test-Path $checksumFile) {
            Remove-Item $checksumFile -Force
          }
          foreach ($file in @($setup, $portable)) {
            if (!(Test-Path $file)) {
              throw "Missing artifact: $file"
            }
            $hash = (Get-FileHash -Path $file -Algorithm SHA256).Hash.ToLower()
            "$hash *$(Split-Path $file -Leaf)" | Out-File -FilePath $checksumFile -Append -Encoding ascii
          }

      - name: Upload workflow artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-release-assets
          path: |
            dist/BetterPDF-${{ steps.meta.outputs.version }}-win-x64-setup.exe
            dist/BetterPDF-${{ steps.meta.outputs.version }}-win-x64-portable.zip
            dist/SHA256SUMS.txt

      - name: Publish GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            dist/BetterPDF-${{ steps.meta.outputs.version }}-win-x64-setup.exe
            dist/BetterPDF-${{ steps.meta.outputs.version }}-win-x64-portable.zip
            dist/SHA256SUMS.txt
